<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wireloop · Observability</title>
    <style>
        :root {
            --bg: #0d1117;
            --surface: #161b22;
            --border: #30363d;
            --text: #e6edf3;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --green: #3fb950;
            --red: #f85149;
            --orange: #d29922;
            --purple: #bc8cff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            min-height: 100vh;
        }

        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header h1 span { color: var(--accent); }
        .header-right { display: flex; align-items: center; gap: 12px; font-size: 13px; color: var(--text-muted); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; }
        .status-dot.error { background: var(--red); }

        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        .stat-card .label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .stat-card .value.green { color: var(--green); }
        .stat-card .value.accent { color: var(--accent); }
        .stat-card .value.orange { color: var(--orange); }
        .stat-card .value.purple { color: var(--purple); }

        /* Section */
        .section { margin-bottom: 32px; }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        /* Chart */
        .chart-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 32px;
        }
        .chart-bars {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 160px;
            padding-top: 8px;
        }
        .chart-bar {
            flex: 1;
            background: var(--accent);
            border-radius: 3px 3px 0 0;
            min-width: 4px;
            position: relative;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .chart-bar:hover { opacity: 0.8; }
        .chart-bar .tooltip {
            display: none;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 10;
        }
        .chart-bar:hover .tooltip { display: block; }
        .chart-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--text-muted); }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .data-table th {
            text-align: left;
            padding: 10px 14px;
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.15);
        }
        .data-table td {
            padding: 10px 14px;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: rgba(88,166,255,0.04); }
        .avatar { width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        .badge.green { background: rgba(63,185,80,0.15); color: var(--green); }
        .badge.red { background: rgba(248,81,73,0.15); color: var(--red); }
        .badge.orange { background: rgba(210,153,34,0.15); color: var(--orange); }

        /* Errors */
        .error-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .error-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        .error-card .count { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
        .error-card .count.ok { color: var(--green); }
        .error-card .count.warn { color: var(--orange); }
        .error-card .count.bad { color: var(--red); }
        .error-card .desc { font-size: 13px; color: var(--text-muted); }

        /* DB Pool */
        .pool-bar {
            height: 24px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            margin-top: 8px;
        }
        .pool-segment { height: 100%; transition: width 0.3s; }
        .pool-segment.active { background: var(--accent); }
        .pool-segment.idle { background: var(--green); }
        .pool-legend { display: flex; gap: 16px; margin-top: 8px; font-size: 12px; color: var(--text-muted); }
        .pool-legend span::before {
            content: '';
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 2px;
            margin-right: 4px;
            vertical-align: middle;
        }
        .pool-legend .active::before { background: var(--accent); }
        .pool-legend .idle::before { background: var(--green); }
        .pool-legend .free::before { background: var(--border); }

        .loading { text-align: center; padding: 60px; color: var(--text-muted); }
        .error-msg { text-align: center; padding: 40px; color: var(--red); }

        @media (max-width: 768px) {
            .container { padding: 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><span>⚡</span> Wireloop <span>Observability</span></h1>
        <div class="header-right">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Connecting...</span>
            <span>|</span>
            <span id="lastRefresh">—</span>
        </div>
    </div>

    <div class="container" id="app">
        <div class="loading" id="loadingState">Loading dashboard...</div>
    </div>

    <script>
        const API_BASE = window.OBS_API_BASE || 'https://wireloop.onrender.com';
        const REFRESH_INTERVAL = 30000; // 30 seconds

        // Prompt for credentials once (stored in memory only)
        let authHeader = '';
        function getAuth() {
            if (authHeader) return authHeader;
            const user = prompt('Observability Username:');
            const pass = prompt('Observability Password:');
            if (!user || !pass) {
                document.getElementById('app').innerHTML = '<div class="error-msg">Authentication required</div>';
                throw new Error('No credentials');
            }
            authHeader = 'Basic ' + btoa(user + ':' + pass);
            return authHeader;
        }

        async function apiFetch(endpoint) {
            const res = await fetch(API_BASE + '/api/admin/' + endpoint, {
                headers: { 'Authorization': getAuth() }
            });
            if (res.status === 401) {
                authHeader = '';
                document.getElementById('app').innerHTML = '<div class="error-msg">Invalid credentials. Refresh to retry.</div>';
                throw new Error('Unauthorized');
            }
            if (!res.ok) {
                const body = await res.text().catch(() => '');
                console.error(`[obs] ${endpoint} failed: ${res.status}`, body);
                return null; // Return null instead of throwing — let other endpoints succeed
            }
            return res.json();
        }

        function timeAgo(dateStr) {
            const s = Math.floor((Date.now() - new Date(dateStr).getTime()) / 1000);
            if (s < 60) return s + 's ago';
            if (s < 3600) return Math.floor(s / 60) + 'm ago';
            if (s < 86400) return Math.floor(s / 3600) + 'h ago';
            return Math.floor(s / 86400) + 'd ago';
        }

        function errSeverity(n) {
            if (n === 0) return 'ok';
            if (n < 5) return 'warn';
            return 'bad';
        }

        async function loadDashboard() {
            try {
                const [stats, users, errors, timeline, loops] = await Promise.all([
                    apiFetch('stats'),
                    apiFetch('users'),
                    apiFetch('errors'),
                    apiFetch('messages-timeline'),
                    apiFetch('active-loops'),
                ]);

                document.getElementById('statusDot').className = 'status-dot';
                document.getElementById('statusText').textContent = 'Connected';
                document.getElementById('lastRefresh').textContent = 'Updated ' + new Date().toLocaleTimeString();

                // Fallback for any endpoint that returned null
                const s = stats || {};
                const u = users || [];
                const e = errors || {};
                const t = timeline || [];
                const l = loops || [];

                const pool = s.db_pool || {};
                const maxConns = pool.max_conns || 1;
                const activePercent = ((pool.acquired_conns || 0) / maxConns * 100).toFixed(0);
                const idlePercent = ((pool.idle_conns || 0) / maxConns * 100).toFixed(0);

                // Build chart
                const maxMsg = Math.max(...t.map(d => d.count), 1);
                const chartBars = t.map(d => {
                    const h = Math.max((d.count / maxMsg) * 100, 2);
                    return `<div class="chart-bar" style="height:${h}%"><div class="tooltip">${d.day}: ${d.count} msgs</div></div>`;
                }).join('');
                const chartLabels = t.length > 0
                    ? `<span>${t[0].day}</span><span>${t[t.length - 1].day}</span>`
                    : '<span>No data</span>';

                // Build users table
                const userRows = u.slice(0, 25).map(usr => `
                    <tr>
                        <td>${usr.avatar_url ? `<img class="avatar" src="${usr.avatar_url}" alt="">` : ''}${usr.username}</td>
                        <td>${usr.loop_count}</td>
                        <td>${usr.message_count}</td>
                        <td><span class="badge ${usr.profile_completed ? 'green' : 'orange'}">${usr.profile_completed ? 'Complete' : 'Incomplete'}</span></td>
                        <td>${timeAgo(usr.created_at)}</td>
                    </tr>
                `).join('');

                // Build loops table
                const loopRows = l.map(lp => `
                    <tr>
                        <td><strong>${lp.name}</strong></td>
                        <td>${lp.member_count}</td>
                        <td>${lp.channel_count}</td>
                        <td>${lp.total_messages}</td>
                        <td><span class="badge ${lp.messages_today > 0 ? 'green' : ''}">${lp.messages_today}</span></td>
                        <td>${timeAgo(lp.created_at)}</td>
                    </tr>
                `).join('');

                document.getElementById('app').innerHTML = `
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="label">Total Users</div>
                            <div class="value accent">${s.total_users ?? '—'}</div>
                            <div class="sub">+${s.users_today ?? 0} today · +${s.users_this_week ?? 0} this week</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Total Messages</div>
                            <div class="value green">${s.total_messages ?? '—'}</div>
                            <div class="sub">+${s.messages_today ?? 0} today</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Loops</div>
                            <div class="value purple">${s.total_loops ?? '—'}</div>
                            <div class="sub">${s.total_channels ?? 0} channels</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Memberships</div>
                            <div class="value">${s.total_memberships ?? '—'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Notifications</div>
                            <div class="value orange">${s.total_notifications ?? '—'}</div>
                            <div class="sub">${s.unread_notifications ?? 0} unread</div>
                        </div>
                        <div class="stat-card">
                            <div class="label">Pinned Messages</div>
                            <div class="value">${s.pinned_messages ?? '—'}</div>
                        </div>
                    </div>

                    <!-- Message Timeline -->
                    <div class="chart-container">
                        <div class="section-title">Messages (Last 30 Days)</div>
                        <div class="chart-bars">${chartBars}</div>
                        <div class="chart-labels">${chartLabels}</div>
                    </div>

                    <!-- DB Pool -->
                    <div class="section">
                        <div class="section-title">Database Pool</div>
                        <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;">
                            <div style="font-size:13px;margin-bottom:4px;">
                                <strong>${pool.acquired_conns || 0}</strong> active · 
                                <strong>${pool.idle_conns || 0}</strong> idle · 
                                <strong>${pool.total_conns || 0}</strong>/${pool.max_conns || 0} total
                            </div>
                            <div class="pool-bar">
                                <div class="pool-segment active" style="width:${activePercent}%"></div>
                                <div class="pool-segment idle" style="width:${idlePercent}%"></div>
                            </div>
                            <div class="pool-legend">
                                <span class="active">Active (${activePercent}%)</span>
                                <span class="idle">Idle (${idlePercent}%)</span>
                                <span class="free">Free</span>
                            </div>
                        </div>
                    </div>

                    <!-- Errors / Anomalies -->
                    <div class="section">
                        <div class="section-title">Anomalies</div>
                        <div class="error-grid">
                            <div class="error-card">
                                <div class="count ${errSeverity(e.incomplete_profiles ?? 0)}">${e.incomplete_profiles ?? '—'}</div>
                                <div class="desc">Incomplete Profiles</div>
                            </div>
                            <div class="error-card">
                                <div class="count ${errSeverity(e.users_no_loops ?? 0)}">${e.users_no_loops ?? '—'}</div>
                                <div class="desc">Users Without Loops</div>
                            </div>
                            <div class="error-card">
                                <div class="count ${errSeverity(e.orphaned_messages ?? 0)}">${e.orphaned_messages ?? '—'}</div>
                                <div class="desc">Orphaned Messages</div>
                            </div>
                            <div class="error-card">
                                <div class="count ${errSeverity(e.deleted_messages ?? 0)}">${e.deleted_messages ?? '—'}</div>
                                <div class="desc">Deleted Messages</div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div class="section">
                        <div class="section-title">Recent Users (${u.length})</div>
                        <table class="data-table">
                            <thead>
                                <tr><th>User</th><th>Loops</th><th>Messages</th><th>Profile</th><th>Joined</th></tr>
                            </thead>
                            <tbody>${userRows || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">No users yet</td></tr>'}</tbody>
                        </table>
                    </div>

                    <!-- Loops Table -->
                    <div class="section">
                        <div class="section-title">Active Loops</div>
                        <table class="data-table">
                            <thead>
                                <tr><th>Loop</th><th>Members</th><th>Channels</th><th>Messages</th><th>Today</th><th>Created</th></tr>
                            </thead>
                            <tbody>${loopRows || '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">No loops yet</td></tr>'}</tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                if (err.message === 'Unauthorized' || err.message === 'No credentials') return;
                document.getElementById('statusDot').className = 'status-dot error';
                document.getElementById('statusText').textContent = 'Error: ' + err.message;
                console.error('Dashboard error:', err);
            }
        }

        // Initial load + auto-refresh
        loadDashboard();
        setInterval(loadDashboard, REFRESH_INTERVAL);
    </script>
</body>
</html>
